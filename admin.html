<!DOCTYPE html>
<html>
<head>
    <title>后台管理系统</title>
    <style>
        body { font-family: Arial; margin: 20px; }
        .user-card { 
            border: 1px solid #ddd; 
            padding: 15px; 
            margin: 10px 0; 
            border-radius: 5px;
            background: #f9f9f9;
        }
        .user-card.approved { border-left: 4px solid #07c160; }
        .user-card.pending { border-left: 4px solid #ffba00; }
        button { 
            padding: 5px 10px; 
            margin: 0 5px; 
            cursor: pointer; 
        }
        .approve-btn { background: #07c160; color: white; border: none; }
        .reject-btn { background: #ff4757; color: white; border: none; }
    </style>
</head>
<body>
    <h1>用户审核管理</h1>
    <div id="userList"></div>

<script>
    // 获取用户列表
    async function loadUsers() {
        try {
            const SUPABASE_URL = 'https://wqrfmwakqkuiutiezngc.supabase.co';
            const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndxcmZtd2FrcWt1aXV0aWV6bmdjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI1MTE4MzUsImV4cCI6MjA3ODA4NzgzNX0.LClSKDW1C9tf9MEq8nKyYLnSR69-f6XHvlwhOX7LSAg';
            
            
            const response = await fetch(SUPABASE_URL + '/rest/v1/customers?select=*&order=created_at.desc', {
                headers: {
                    'apikey': SUPABASE_KEY,
                    'Authorization': 'Bearer ' + SUPABASE_KEY
                }
            });
            const users = await response.json();
            displayUsers(users);
        } catch (error) {
            console.error('加载用户失败:', error);
            alert('加载用户失败：' + error.message);
        }
    }
    
    // 显示用户列表
    function displayUsers(users) {
        const userListEl = document.getElementById('userList');
        
        userListEl.innerHTML = users.map(user => `
            <div class="user-card ${user.status === 1 ? 'approved' : 'pending'}">
                <h3>${user.name} - ${user.phone}</h3>
                <p>公司：${user.company || '未填写'} | 职位：${user.position || '未填写'}</p>
                <p>状态：${getStatusText(user.status)}</p>
                <p>提交时间：${new Date(user.created_at).toLocaleString()}</p>
                ${user.status === 0 ? `
                    <button class="approve-btn" onclick="approveUser(${user.id})">审核通过</button>
                    <button class="reject-btn" onclick="rejectUser(${user.id})">审核拒绝</button>
                ` : ''}
                ${user.seat_number ? `<p><strong>座位号：${user.seat_number}</strong></p>` : ''}
            </div>
        `).join('');
    }
    
    // 审核通过
    async function approveUser(userId) {
        const seatNumber = prompt('请输入座位号：');
        if (!seatNumber) return;
        
        try {
            const SUPABASE_URL = 'https://wqrfmwakqkuiutiezngc.supabase.co';
            const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndxcmZtd2FrcWt1aXV0aWV6bmdjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI1MTE4MzUsImV4cCI6MjA3ODA4NzgzNX0.LClSKDW1C9tf9MEq8nKyYLnSR69-f6XHvlwhOX7LSAg';
            
            await fetch(SUPABASE_URL + '/rest/v1/customers?id=eq.' + userId, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    'apikey': SUPABASE_KEY,
                    'Authorization': 'Bearer ' + SUPABASE_KEY,
                    'Prefer': 'return=minimal'
                },
                body: JSON.stringify({
                    status: 1,
                    seat_number: seatNumber
                })
            });
            
            alert('审核完成！');
            loadUsers(); // 重新加载列表
        } catch (error) {
            alert('操作失败：' + error.message);
        }
    }
    
    // 审核拒绝
    async function rejectUser(userId) {
        try {
            const SUPABASE_URL = 'https://wqrfmwakqkuiutiezngc.supabase.co';
            const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndxcmZtd2FrcWt1aXV0aWV6bmdjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI1MTE4MzUsImV4cCI6MjA3ODA4NzgzNX0.LClSKDW1C9tf9MEq8nKyYLnSR69-f6XHvlwhOX7LSAg';
            
            await fetch(SUPABASE_URL + '/rest/v1/customers?id=eq.' + userId, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    'apikey': SUPABASE_KEY,
                    'Authorization': 'Bearer ' + SUPABASE_KEY,
                    'Prefer': 'return=minimal'
                },
                body: JSON.stringify({
                    status: 2
                })
            });
            
            alert('已拒绝该用户');
            loadUsers();
        } catch (error) {
            alert('操作失败：' + error.message);
        }
    }
    
    function getStatusText(status) {
        const statusMap = {
            0: '待审核',
            1: '审核通过',
            2: '审核拒绝'
        };
        return statusMap[status] || '未知状态';
    }
    
    // 页面加载时获取用户列表
    loadUsers();
    
    // 添加刷新按钮功能（可选）
    document.addEventListener('DOMContentLoaded', function() {
        // 可以添加一个刷新按钮
        const refreshBtn = document.createElement('button');
        refreshBtn.textContent = '刷新列表';
        refreshBtn.style.cssText = 'padding: 10px 20px; margin: 10px; background: #1890ff; color: white; border: none; border-radius: 4px; cursor: pointer;';
        refreshBtn.onclick = loadUsers;
        document.body.insertBefore(refreshBtn, document.getElementById('userList'));
    });
</script>
</body>
</html>
